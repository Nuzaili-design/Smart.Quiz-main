<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Science Quiz</title>
    <style>
        body {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            font-family: 'Poppins', sans-serif;
        }
        .quiz-container {
            background-color: white;
            color: #333;
            padding: 30px;
            margin: auto;
            margin-top: 50px;
            box-shadow: 0px 0px 10px black;
            max-width: 600px;
            border-radius: 10px;
        }
        #timer {
            font-weight: bold;
            margin-bottom: 20px;
        }
        .question-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        .question {
            margin-bottom: 20px;
        }
        hr {
            border-top: 2px solid #2c3e50;
            margin: 15px 0;
        }
        .alert {
            display: none;
        }
    </style>
</head>
<body>

<div class="container quiz-container">
    <h2 class="text-center">Science Quiz</h2>
    <div id="timer" class="text-center">Time Remaining: 4:00</div>
    <form id="quizForm">
        <div id="quizQuestions"></div> <!-- Questions will be inserted dynamically here -->
        <div class="mb-3">
            <label for="userName" class="form-label">Name:</label>
            <input type="text" class="form-control" id="userName" name="Name" required>
        </div>
        <div class="mb-3">
            <label for="userEmail" class="form-label">Email:</label>
            <input type="email" class="form-control" id="userEmail" name="Email" required>
        </div>
        <div class="mb-3">
            <label for="quizScore" class="form-label">Quiz score:</label>
            <textarea class="form-control" id="quizScore" name="Message" rows="2" readonly></textarea>
        </div>
        <button type="submit" class="btn btn-dark">Submit Quiz</button>
    </form>
    <span id="msg"></span>
</div>

<script>
    // Load the quiz data from localStorage
    const quizData = JSON.parse(localStorage.getItem('quizData'));

    if (!quizData) {
        alert('No quiz found! Please create a quiz first in the admin panel.');
        window.location.href = "admin.html"; // Redirect if no quiz is found
    }

    // Dynamically display questions with styling
    window.onload = function () {
        const quizContainer = document.getElementById('quizQuestions');
        let quizHTML = '';

        for (let i = 1; i <= 10; i++) {
            const question = quizData[`question${i}`];
            const options = question.options;

            quizHTML += `
                <div class="question">
                    <p class="question-title">Question ${i}:</p>
                    <label>${question.question}</label>
                    <div class="alert alert-danger" style="display: none;">Please select an answer for this question.</div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="question${i}" value="${options[0]}" required>
                        <label class="form-check-label">${options[0]}</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="question${i}" value="${options[1]}" required>
                        <label class="form-check-label">${options[1]}</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="question${i}" value="${options[2]}" required>
                        <label class="form-check-label">${options[2]}</label>
                    </div>
                </div>
                <hr>
            `;
        }

        quizContainer.innerHTML = quizHTML; // Insert the formatted questions
    };

    // Timer Functionality
    const totalTime = 4 * 60; // 4 minutes in seconds
    let timeLeft = totalTime;

    function updateTimer() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        document.getElementById('timer').textContent = `Time Remaining: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        timeLeft--;

        if (timeLeft < 0) {
            clearInterval(timerInterval);
            alert("Time's up!");
            submitQuiz();
        }
    }

    const timerInterval = setInterval(updateTimer, 1000);

    // Form validation and quiz submission
    document.getElementById("quizForm").addEventListener("submit", function(event) {
        event.preventDefault(); // Prevent default form submission

        let valid = true;
        const questions = document.querySelectorAll(".question");

        // Validate if each question is answered
        questions.forEach((question) => {
            const alert = question.querySelector(".alert");
            const options = question.querySelectorAll("input[type='radio']");
            let answered = false;
            options.forEach(option => {
                if (option.checked) {
                    answered = true;
                }
            });
            if (!answered) {
                valid = false;
                alert.style.display = "block";
            } else {
                alert.style.display = "none";
            }
        });

        if (valid) {
            submitQuiz();
        } else {
            alert("Please answer all questions before submitting.");
        }
    });

    // Submit the quiz and calculate score
    function submitQuiz() {
        let score = 0;
        const correctAnswers = {};

        // Loop through the stored quizData and compare answers
        for (let i = 1; i <= 10; i++) {
            correctAnswers[`question${i}`] = quizData[`question${i}`].correct;
        }

        // Check answers and calculate score
        for (let i = 1; i <= 10; i++) {
            const selectedAnswer = document.querySelector(`input[name="question${i}"]:checked`);
            if (selectedAnswer && selectedAnswer.value === correctAnswers[`question${i}`]) {
                score++;
            }
        }

        // Get current date and time
        const currentDate = new Date();
        const submissionTime = currentDate.toLocaleString();

        // Store the score and time in localStorage
        localStorage.setItem("quizScore", score);
        localStorage.setItem("submissionTime", submissionTime);

        // Display score in the readonly textarea
        document.getElementById('quizScore').value = `Your quiz score is: ${score}/10. Submitted at: ${submissionTime}`;

        // Submit the form data to Google Sheets
        const form = document.forms['quizForm'];
        const scriptURL = 'https://script.google.com/macros/s/AKfycbzSLWMP4KpbxlzdMRiIqQ8TmDbmrPP3bvRhvplwiEDAR6Baw9vCIe9bKHEzjxhKwT9_cQ/exec';
        const msg = document.getElementById("msg");

        const formData = new FormData(form);
        formData.append('SubmissionTime', submissionTime);

        fetch(scriptURL, { method: 'POST', body: formData })
            .then(response => {
                msg.innerHTML = "Quiz submitted successfully!";
                setTimeout(function () {
                    msg.innerHTML = "";
                    form.reset();
                    clearInterval(timerInterval);
                    window.location.href = "result.html";
                }, 3000);
            })
            .catch(error => console.error('Error!', error.message));
    }
</script>

</body>
</html>

